import random, os
from telethon import TelegramClient, events
api_id = os.getenv('API_ID')      
api_hash = os.getenv('API_HASH')  
bot_token = os.getenv('BOT_TOKEN')
ABH = TelegramClient('code', api_id, api_hash).start(bot_token=bot_token)
group_game_status = {}
number2 = None
game_board = [["ğŸ‘Š", "ğŸ‘Š", "ğŸ‘Š", "ğŸ‘Š", "ğŸ‘Š", "ğŸ‘Š"]]
numbers_board = [["1ï¸âƒ£", "2ï¸âƒ£", "3ï¸âƒ£", "4ï¸âƒ£", "5ï¸âƒ£", "6ï¸âƒ£"]]
original_game_board = [["ğŸ‘Š", "ğŸ‘Š", "ğŸ‘Š", "ğŸ‘Š", "ğŸ‘Š", "ğŸ‘Š"]]
points = {}
def format_board(game_board, numbers_board):
    formatted_board = ""
    formatted_board += " ".join(numbers_board[0]) + "\n"
    formatted_board += " ".join(game_board[0]) + "\n"
    return formatted_board
def reset_game(chat_id):
    global game_board, number2, group_game_status
    game_board = [row[:] for row in original_game_board]
    number2 = None
    group_game_status[chat_id]['game_active'] = False
    group_game_status[chat_id]['active_player_id'] = None
group_game_status = {}
@ABH.on(events.NewMessage(pattern='/rings'))
async def handle_start_game(event):
    global number2
    chat_id = event.chat_id
    user_id = event.sender_id
    username = event.sender.username or "unknown"
    if chat_id not in group_game_status:
        group_game_status[chat_id] = {'game_active': False, 'active_player_id': None}    
    if not group_game_status[chat_id]['game_active']:
        group_game_status[chat_id]['game_active'] = True
        group_game_status[chat_id]['active_player_id'] = user_id
        number2 = random.randint(1, 6)
        group_game_status[chat_id]['number2'] = number2
        await event.respond(
            f"Ø¹Ø²ÙŠØ²ÙŠ [{event.sender.first_name}](https://t.me/@{username})! ØªÙ… ØªØ³Ø¬ÙŠÙ„Ùƒ ÙÙŠ Ù„Ø¹Ø¨Ø© Ù…Ø­ÙŠØ¨Ø³ \nØ§Ø±Ø³Ù„ `Ø¬ÙŠØ¨ ` + Ø±Ù‚Ù… Ù„Ù„Ø­Ø²Ø± \n Ø§Ø±Ø³Ù„ `Ø·Ùƒ ` + Ø±Ù‚Ù… Ù„Ù„ØªØ®Ù…ÙŠÙ†.",
            parse_mode="Markdown"
        )
@ABH.on(events.NewMessage(pattern=r'Ø¬ÙŠØ¨ (\d+)'))
async def handle_guess(event):
    global number2, game_board, points, group_game_status
    chat_id = event.chat_id
    if chat_id in group_game_status and group_game_status[chat_id]['game_active']:
        try:
            guess = int(event.text.split()[1])  
            if 1 <= guess <= 6:  
                if guess == number2:
                    winner_id = event.sender_id 
                    points[winner_id] = points.get(winner_id, 0) + 1 
                    sender_first_name = event.sender.first_name
                    game_board = [["ğŸ’" if i == number2 - 1 else "ğŸ–ï¸" for i in range(6)]]
                    await event.reply(f'ğŸ‰ Ø§Ù„Ù Ù…Ø¨Ø±ÙˆÙƒ! Ø§Ù„Ù„Ø§Ø¹Ø¨ ({sender_first_name}) ÙˆØ¬Ø¯ Ø§Ù„Ù…Ø­Ø¨Ø³ ğŸ’!\n{format_board(game_board, numbers_board)}')
                    reset_game(chat_id)
                else: 
                    sender_first_name = event.sender.first_name
                    game_board = [["âŒ" if i == guess - 1 else "ğŸ–ï¸" for i in range(6)]]
                    await event.reply(f"Ø¶Ø§Ø¹ Ø§Ù„Ø¨Ø§Øª Ù…Ø§Ø¶Ù† Ø¨Ø¹Ø¯ ØªÙ„Ú¯ÙˆÙ†Ø© â˜¹ï¸ \n{format_board(game_board, numbers_board)}")
                    reset_game(chat_id)
            else:
                await event.reply("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­ Ø¨ÙŠÙ† 1 Ùˆ 6.")
        except (IndexError, ValueError):
            await event.reply("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­ Ø¨ÙŠÙ† 1 Ùˆ 6.")
@ABH.on(events.NewMessage(pattern=r'Ø·Ùƒ (\d+)'))
async def handle_strike(event):
    global game_board, number2, group_game_status
    chat_id = event.chat_id
    if chat_id in group_game_status and group_game_status[chat_id]['game_active']:
        try:
            strike_position = int(event.text.split()[1])  
            if strike_position == number2:
                game_board = [["ğŸ’" if i == number2 - 1 else "ğŸ–ï¸" for i in range(6)]]
                await event.reply(f"**Ø®Ø³Ø±Øª!** \n{format_board(game_board, numbers_board)}")
                reset_game(chat_id)

                abh = [
                    "ØªÙ„Ø¹Ø¨ ÙˆØ®ÙˆØ´ ØªÙ„Ø¹Ø¨ ğŸ‘ğŸ»",
                    "Ù„Ùƒ Ø¹Ø§Ø´ ÙŠØ§Ø¨Ø·Ù„ Ø§Ø³ØªÙ…Ø± ğŸ’ªğŸ»",
                    "Ø¹Ù„Ù‰ ÙƒÙŠÙÙƒ Ø±ÙƒØ²Ø²Ø²Ø² Ø§Ù†ØªÙ ÙƒØ¯Ù‡Ø§ ğŸ¤¨",
                    "Ù„Ùƒ ÙˆØ¹Ù„ÙŠ Ø°ÙŠÙŠÙŠØ¨ ğŸ˜"
                ]
                iuABH = random.choice(abh)
                game_board[0][strike_position - 1] = 'ğŸ–ï¸'
                await event.reply(f" {iuABH} \n{format_board(game_board, numbers_board)}")
            elif strike_position != number2:
                await event.reply('Ø®Ø·Ø§')
        except (IndexError, ValueError):
            await event.reply("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­ Ø¨ÙŠÙ† 1 Ùˆ 6.")
            
@ABH.on(events.NewMessage(pattern='/Ù…Ø­ÙŠØ¨Ø³'))
async def show_number(event):
    """Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡ Ø¥Ù„Ù‰ @k_4x1"""
    chat_id = event.chat_id
    if chat_id in group_game_status and group_game_status[chat_id]['game_active']:
        target_user_id = 1910015590  
        await ABH.send_message(target_user_id, f"Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ù‡Ùˆ: {number2}")
        await event.reply("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ø¥Ù„Ù‰ @k_4x1.")
    else:
        await event.reply("Ù„Ù… ØªØ¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø¹Ø¯. Ø£Ø±Ø³Ù„ /rings Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©.")
ABH.run_until_disconnected()
